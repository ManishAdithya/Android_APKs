from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad
import base64

def decrypt_aes(encrypted_data, key):
    # The encrypted data is base64 encoded
    encrypted_bytes = base64.b64decode(encrypted_data)
    
    # The key needs to be 32 bytes for AES-256
    key_bytes = key.encode('utf-8')
    
    # Extract IV (first 16 bytes) and actual ciphertext
    iv = encrypted_bytes[:16]
    ciphertext = encrypted_bytes[16:]
    
    # Create AES cipher
    cipher = AES.new(key_bytes, AES.MODE_CBC, iv)
    
    # Decrypt and unpad
    decrypted = unpad(cipher.decrypt(ciphertext), AES.block_size)
    
    return decrypted.decode('utf-8')

# The encryption key you provided
key = "&hX2aJ7$SdfW8!zQ9uB1Yx4LmN$XvG8C"

# Encrypted values
core_enc = "Mn6J47+7OPh5Oev9UkTH5MgASX+WlZSOeIjODT0C5pXGF6iwsTh28tTdh74zqBWF"
acc_enc = "0p1SEi9/UkhuMhUGx+2aEvOJ+IioKHaw5nQNHqyo6hghj9+lE1EcLCS202UN40ZRqYyfOrbuIiyJ5cKVOdU79A=="
ns_enc = "i8BzP5dpLusLyVaMQfyT9GT3JkMNNUJEYKEG9KYIkECid2rLn3PL+H1TGaNdHF406tjdEMBHTHLoiEr9zsParg=="
api = "rP79AifBcvxyHj9gInpNur3vjnnyCMK52cuMHmMUBAW9jxDSTYTAUP1gPtcfb5auT2Bps11yF1/pHPw6Dpfp6w=="
url2 = "oX2m51CiKpsKMG4pEqMbN+JscM3FsuWnohtXf9ClwDTC967Qe6hTQWduWEWGz4I1"
encrypted = "iItgf8Wg7MWl/OqGfLnJ2Yska/9DhvK9DWuYZwpF8XMb0xJSVxOVfqJc1MJWygh8gT/GOYuzyjTZTGLSqDHGug=="
try:
    # Decrypt each value
    core_decrypted = decrypt_aes(core_enc, key)
    acc_decrypted = decrypt_aes(acc_enc, key)
    ns_decrypted = decrypt_aes(ns_enc, key)
    api_decrypted = decrypt_aes(api, key)
    url2_decrypted = decrypt_aes(url2, key)
    decrypted = decrypt_aes(encrypted, key)
    
    # Construct the URL
    url = f"https://{core_decrypted}/client/v4/accounts/{acc_decrypted}/storage/kv/namespaces/{ns_decrypted}/values/test"
    
    print("Decrypted Values:")
    print(f"core.txt: {core_decrypted}")
    print(f"acc.txt: {acc_decrypted}")
    print(f"ns.txt: {ns_decrypted}")
    print(f"api.txt: {api_decrypted}")
    print(f"url2: {url2_decrypted}")
    print(f"decrypted: {decrypted}")
    print("\nConstructed URL:")
    print(url)

except Exception as e:
    print(f"Decryption failed: {str(e)}")
    print("Possible reasons:")
    print("- Incorrect key")
    print("- Different AES mode was used (e.g., ECB instead of CBC)")
    print("- Different padding scheme")
    print("- IV handling might be different in the original implementation")